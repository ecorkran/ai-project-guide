#!/bin/bash

# AI Project Guide - IDE Setup Script
# Copies project rules to your IDE configuration directory
# Supports: Cursor, Windsurf

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Script configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Determine if we're in the ai-project-guide source repo or in a project that includes it
if [[ "$SCRIPT_DIR" == */ai-project-guide/scripts ]]; then
    # We're in the source repository
    PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
    RULES_SOURCE_DIR="$PROJECT_ROOT/project-guides/rules"
    AGENTS_SOURCE_DIR="$PROJECT_ROOT/project-guides/agents"
    TARGET_ROOT="$(pwd)"  # Create .cursor/.windsurf in current directory
else
    # We're in a project that includes ai-project-guide
    # Script is in project-documents/scripts/, so go up two levels to project root
    PROJECT_ROOT="$(dirname "$(dirname "$SCRIPT_DIR")")"
    RULES_SOURCE_DIR="$SCRIPT_DIR/../project-guides/rules"
    AGENTS_SOURCE_DIR="$SCRIPT_DIR/../project-guides/agents"
    TARGET_ROOT="$(pwd)"  # Create .cursor/.windsurf in current directory
fi

# Function to check if we're in the right directory
check_directory() {
    local current_dir=$(pwd)
    local script_name=$(basename "$0")
    
    # Check if we're running from the wrong location
    if [[ "$SCRIPT_DIR" == */ai-project-guide/scripts ]]; then
        # In source repo - warn if not in project root
        if [[ "$current_dir" != "$PROJECT_ROOT" ]]; then
            print_status $YELLOW "‚ö†Ô∏è  Warning: You're running the script from the wrong directory!"
            echo ""
            print_status $BLUE "üí° The script should be run from the project root, not from the scripts/ directory."
            echo ""
            print_status $BLUE "Current location: $current_dir"
            print_status $BLUE "Expected location: $PROJECT_ROOT"
            echo ""
            print_status $GREEN "‚úÖ Correct usage:"
            echo "   cd $PROJECT_ROOT"
            echo "   ./scripts/$script_name $1"
            echo ""
            print_status $YELLOW "‚ùì Do you want to continue anyway? (y/N)"
            read -r response
            if [[ ! "$response" =~ ^[Yy]$ ]]; then
                print_status $BLUE "üëã Exiting. Please run from the project root directory."
                exit 0
            fi
            print_status $YELLOW "‚ö†Ô∏è  Continuing... IDE directories will be created in: $current_dir"
            echo ""
        fi
    else
        # In a project with ai-project-guide - this is the correct usage
        print_status $BLUE "‚úÖ Running from project root - IDE directories will be created in: $current_dir"
        echo ""
    fi
}

# Function to show usage
show_usage() {
    echo "Usage: $0 <ide>"
    echo ""
    echo "Supported IDEs:"
    echo "  cursor    - Copy rules to .cursor/rules/ (renames .md to .mdc)"
    echo "  windsurf  - Copy rules to .windsurf/rules/ (keeps .md extension)"
    echo ""
    echo "Examples:"
    echo "  $0 cursor"
    echo "  $0 windsurf"
    echo ""
    echo "This script copies AI project rules from project-guides/ to your IDE's"
    echo "configuration directory and validates frontmatter requirements."
}

# Function to print colored output
print_status() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${NC}"
}

# Function to validate frontmatter
validate_frontmatter() {
    local file=$1
    local filename=$(basename "$file")
    
    if ! grep -q "^---" "$file"; then
        print_status $YELLOW "‚ö†Ô∏è  WARNING: $filename missing frontmatter"
        return 1
    fi
    
    if ! grep -q "description:" "$file"; then
        print_status $YELLOW "‚ö†Ô∏è  WARNING: $filename missing 'description' in frontmatter"
        return 1
    fi
    
    if ! grep -q "globs:" "$file"; then
        print_status $YELLOW "‚ö†Ô∏è  WARNING: $filename missing 'globs' in frontmatter"
        return 1
    fi
    
    return 0
}

# Function to copy and potentially rename files
copy_rules() {
    local source_dir=$1
    local target_dir=$2
    local rename_extension=$3
    local file_type=$4
    
    if [ ! -d "$source_dir" ]; then
        print_status $RED "‚ùå Source directory not found: $source_dir"
        return 1
    fi
    
    local copied_count=0
    local warning_count=0
    
    for file in "$source_dir"/*.md; do
        if [ ! -f "$file" ]; then
            continue
        fi
        
        local filename=$(basename "$file")
        local target_filename="$filename"
        
        # Rename .md to .mdc for cursor
        if [ "$rename_extension" = true ]; then
            target_filename="${filename%.md}.mdc"
        fi
        
        local target_path="$target_dir/$target_filename"
        
        # Copy file
        cp "$file" "$target_path"
        print_status $GREEN "‚úÖ Copied $filename ‚Üí $target_filename"
        
        # Validate frontmatter
        if ! validate_frontmatter "$target_path"; then
            ((warning_count++))
        fi
        
        ((copied_count++))
    done
    
    print_status $BLUE "üìã Copied $copied_count $file_type files"
    if [ $warning_count -gt 0 ]; then
        print_status $YELLOW "‚ö†Ô∏è  $warning_count files have frontmatter issues"
    fi
}

# Main script logic
main() {
    # Check parameters
    if [ $# -eq 0 ]; then
        print_status $RED "‚ùå Error: IDE parameter required"
        echo ""
        show_usage
        exit 1
    fi
    
    local ide=$(echo "$1" | tr '[:upper:]' '[:lower:]')
    
    # Check if we're in the right directory
    check_directory "$1"
    
    # Validate IDE parameter
    case "$ide" in
        cursor|windsurf)
            ;;
        *)
            print_status $RED "‚ùå Error: Unsupported IDE '$1'"
            echo ""
            show_usage
            exit 1
            ;;
    esac
    
    # Set up target directory and file extension behavior
    local target_base_dir="$TARGET_ROOT/.$ide"
    local rules_target_dir="$target_base_dir/rules"
    local rename_to_mdc=false
    
    if [ "$ide" = "cursor" ]; then
        rename_to_mdc=true
    fi
    
    print_status $BLUE "üöÄ Setting up $ide IDE rules..."
    echo ""
    
    # Validate source directories exist
    if [ ! -d "$RULES_SOURCE_DIR" ]; then
        print_status $RED "‚ùå Error: Rules source directory not found: $RULES_SOURCE_DIR"
        print_status $YELLOW "üí° Make sure you're running this from a project that includes ai-project-guide"
        exit 1
    fi
    
    # Create target directory
    mkdir -p "$rules_target_dir"
    print_status $GREEN "üìÅ Created directory: $rules_target_dir"
    
    # Copy rules
    print_status $BLUE "üìÑ Copying rules files..."
    copy_rules "$RULES_SOURCE_DIR" "$rules_target_dir" $rename_to_mdc "rule"
    
    echo ""
    
    # Copy agents if directory exists
    if [ -d "$AGENTS_SOURCE_DIR" ]; then
        print_status $BLUE "ü§ñ Copying agent files..."
        copy_rules "$AGENTS_SOURCE_DIR" "$rules_target_dir" $rename_to_mdc "agent"
    else
        print_status $YELLOW "‚ö†Ô∏è  Agents directory not found, skipping"
    fi
    
    echo ""
    print_status $GREEN "‚úÖ Setup complete for $ide!"
    
    # IDE-specific instructions
    case "$ide" in
        cursor)
            echo ""
            print_status $BLUE "üí° Cursor setup notes:"
            echo "   ‚Ä¢ Rules are now in .cursor/rules/ as .mdc files"
            echo "   ‚Ä¢ Files with frontmatter warnings may need manual fixes"
            echo "   ‚Ä¢ Restart Cursor to ensure rules are loaded"
            ;;
        windsurf)
            echo ""
            print_status $BLUE "üí° Windsurf setup notes:"
            echo "   ‚Ä¢ Rules are now in .windsurf/rules/ as .md files"
            echo "   ‚Ä¢ Files with frontmatter warnings may need manual fixes"
            echo "   ‚Ä¢ Restart Windsurf to ensure rules are loaded"
            ;;
    esac
    
    if grep -q "WARNING" <(echo ""); then
        echo ""
        print_status $YELLOW "‚ö†Ô∏è  Some files had frontmatter issues. For Cursor compatibility,"
        print_status $YELLOW "   ensure all .mdc files have proper YAML frontmatter with:"
        echo "   ---"
        echo "   description: Brief description of what this rule does"
        echo "   globs: [\"**/*.ext\"]"
        echo "   alwaysApply: false"
        echo "   ---"
    fi
}

# Run main function with all arguments
main "$@" 